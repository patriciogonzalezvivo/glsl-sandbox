<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, shrink-to-fit=0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>glsl-sandbox</title>
  </head>
  <body style="margin: 0">
    <script type="module">
      import { WebGLRenderer, PerspectiveCamera, Scene, BoxGeometry, ShaderMaterial, Mesh, Vector2, Vector3 } from 'three';
      import { resolveLygia } from 'resolve-lygia';

      import { GlslSandbox } from '../index.js';

      let W = window,
          D = document;

      let width = W.innerWidth;
      let height = W.innerHeight;
      let pixelRatio = W.devicePixelRatio;

      const renderer = new WebGLRenderer();
      renderer.setPixelRatio(pixelRatio);
      renderer.setSize(width, height);
      D.body.appendChild(renderer.domElement);

      const shader_frag = resolveLygia(/* glsl */`
        uniform sampler2D   u_buffer0;
        uniform sampler2D   u_buffer1;


        uniform vec4        u_date;
        uniform vec2        u_resolution;
        uniform float       u_time;

        #include "lygia/math/const.glsl"
        #include "lygia/space/ratio.glsl"
        #include "lygia/space/scale.glsl"

        #define DIGITS_SIZE vec2(0.09)
        #include "lygia/draw/digits.glsl"

        #include "lygia/filter/gaussianBlur/1D_fast13.glsl"

        #include "lygia/space/sqTile.glsl"
        #include "lygia/draw/circle.glsl"

        void main() {
            vec3 color = vec3(0.0);
            vec2 pixel = 1.0/u_resolution.xy;
            vec2 st = gl_FragCoord.xy * pixel;
            vec2 sst = ratio(st, u_resolution);
            
            #ifdef BUFFER_0
            // Draw the hour and minutes

            sst = scale(sst, 0.25);
            float h = floor( u_date.w / 3600.0);
            float m = floor( mod(u_date.w, 3600.0) / 60.0 );
            float time = 0.0;

            sst -= vec2(0.3, 0.45);
            color += digits(sst, h, 0., 2.0);
            color += digits(sst - vec2(0.2, 0.0), m, 0., 2.);
            
            #elif defined(BUFFER_1) 
            color = gaussianBlur1D_fast13(u_buffer0, st, vec2(1.0, 0.0) * pixel * 3.0).rgb; 

            #else
            color = texture2D(u_buffer0, st).rgb * 0.8;
            vec3 blur = gaussianBlur1D_fast13(u_buffer1, st, vec2(0.0, 1.0) * pixel * 3.0).rgb;

            vec4 t = sqTile(sst * 80.0);
            color += blur * fill(circleSDF(t.xy), 0.5, 0.5);


            #endif

            gl_FragColor = vec4(color, 1.);
        }`);

      // GLSL Buffers
      const glsl_sandbox = new GlslSandbox(renderer);
      glsl_sandbox.load(shader_frag);

      const draw = () => {
          glsl_sandbox.renderMain();
          requestAnimationFrame(draw);
      };

      const resize = () => {
          width = W.innerWidth;
          height = W.innerHeight;
          pixelRatio = W.devicePixelRatio;

          renderer.setPixelRatio(pixelRatio);
          renderer.setSize(width, height);

          glsl_sandbox.setSize(width, height);
      };

      W.addEventListener("resize", resize);
      resize();

      draw();
    </script>
  </body>
</html>
